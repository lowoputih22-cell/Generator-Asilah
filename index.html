<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Generator Soal Pesantren</title>

<style>
/* --------------------------------------------------------------
   GLOBAL STYLE
-------------------------------------------------------------- */
body{
    margin:0;
    background:#eaf0f9;
    font-family:Arial, Helvetica, sans-serif;
    padding:20px;
}

.wrap{
    max-width:520px;
    margin:auto;
}

/* --------------------------------------------------------------
   CARD
-------------------------------------------------------------- */
.card{
    background:white;
    padding:22px;
    border-radius:26px;
    box-shadow:0 8px 24px rgba(0,0,0,0.09);
    margin-bottom:22px;
}

label{
    font-weight:600;
    font-size:14px;
    margin-bottom:5px;
    display:block;
}

/* input & select */
input, select{
    width:100%;
    padding:12px;
    border-radius:14px;
    border:1px solid #cfd9ea;
    background:#f9fbff;
    font-size:15px;
    margin-bottom:14px;
}

/* textarea soal */
textarea{
    width:100%;
    padding:14px;
    border-radius:16px;
    border:1px solid #cfd9ea;
    background:#fafcff;
    font-size:16px;
    min-height:140px;
    resize:none;
    box-shadow:inset 0 0 5px rgba(0,0,0,0.03);
}

/* toggle */
.toggleBox{
    width:100%;
    background:#f0f4fa;
    border-radius:20px;
    padding:10px;
    display:flex;
    justify-content:space-between;
    align-items:center;
    margin-bottom:14px;
}
.toggleBtn{
    width:52px;
    height:24px;
    background:#cdd8eb;
    border-radius:20px;
    position:relative;
    cursor:pointer;
}
.toggleKnob{
    width:22px;
    height:22px;
    background:white;
    border-radius:50%;
    position:absolute;
    top:1px;
    left:1px;
    transition:.25s;
}
.toggleKnob.rtl{ left:29px; }

/* tombol */
button{
    width:100%;
    padding:12px;
    font-size:15px;
    border:none;
    border-radius:14px;
    background:#4c82ff;
    color:white;
    font-weight:600;
    margin-top:10px;
    cursor:pointer;
}
button.red{ background:#d33; }
button.small{
    font-size:13px;
    padding:8px 14px;
    width:auto;
}

/* tabel */
table{
    width:100%;
    border-collapse:collapse;
    margin-top:10px;
}
table td{
    padding:7px;
    border-bottom:1px solid #e6e8ee;
    font-size:14px;
}
.iconBtn{
    padding:6px 10px;
    border-radius:10px;
    border:none;
    background:#e8f0ff;
    color:#2756d8;
    font-size:12px;
    cursor:pointer;
}
.iconBtn.del{
    background:#ffe5e7;
    color:#c22;
}

/* PRINT AREA */
.paper{
    width:210mm;
    min-height:330mm;
    padding:15mm;
    box-sizing:border-box;
    font-size:14px;
}

/* tombol di modal */
.modalActions{
    padding:14px;
    display:flex;
    gap:10px;
}
.modalActions button{
    flex:1;
}

/* --------------------------------------------------------------
   TOAST
-------------------------------------------------------------- */
#toast{
    position:fixed;
    top:-80px;
    left:50%;
    transform:translateX(-50%);
    background:#4c82ff;
    color:white;
    padding:14px 24px;
    border-radius:12px;
    font-weight:600;
    box-shadow:0 8px 24px rgba(0,0,0,0.2);
    transition:0.35s;
    z-index:999999;
    opacity:0;
}

#toast.show{
    top:20px;
    opacity:1;
}

/* --------------------------------------------------------------
   RESET CONFIRM MODAL
-------------------------------------------------------------- */
#confirmOverlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.35);
    backdrop-filter: blur(6px);
    -webkit-backdrop-filter: blur(6px);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 99999;
}
#deleteOverlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.35);
    backdrop-filter: blur(6px);
    -webkit-backdrop-filter: blur(6px);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 99999;
}
#deleteBox {
    background: white;
    padding: 24px;
    width: 85%;
    max-width: 360px;
    border-radius: 18px;
    text-align: center;
}
#deleteBox h3 {
    margin-top: 0;
    font-size: 18px;
}
#deleteBox button {
    margin-top: 14px;
}
#confirmBox{
    background:white;
    padding:24px;
    width:85%;
    max-width:360px;
    border-radius:18px;
    text-align:center;
    margin-left:auto;      /* << center horizontal */
    margin-right:auto;     /* << center horizontal */
}
#confirmBox h3{
    margin-top:0;
    font-size:18px;
}
#confirmBox button{
    margin-top:14px;
}

/* --------------------------------------------------------------
   PRINT PDF SETTINGS
-------------------------------------------------------------- */
@media print{
    @page{
        size: 210mm 330mm; /* F4 */
        margin: 0.5mm; /* 1.5 cm */
    }
}
#fan {
    box-sizing: border-box !important;
}
input, select, textarea {
    box-sizing: border-box;
}
.toggleBox {
    box-sizing: border-box !important;
    width: 100%;
}
@media print {
  @page {
    size: 210mm 330mm; /* F4 / Folio */
    margin: 10mm; /* bebas mau diganti */
  }
}
/* Background gelap transparan */
.modal {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.5);
  backdrop-filter: blur(2px);
  justify-content: center;
  align-items: center;
  z-index: 999;
}

/* Box edit */
.edit-box {
  width: 90%;
  max-width: 420px;
  background: #fff;
  border-radius: 18px;
  padding: 22px;
  box-shadow: 0 10px 25px rgba(0,0,0,0.15);
  animation: pop 0.25s ease;
}

@keyframes pop {
  from { transform: scale(0.85); opacity: 0; }
  to   { transform: scale(1); opacity: 1; }
}

.modal-title {
  text-align: center;
  font-size: 22px;
  font-weight: 700;
  margin-bottom: 15px;
  color: #333;
}

/* Label */
.input-label {
  font-size: 14px;
  font-weight: 600;
  margin-top: 10px;
  color: #444;
}

/* Input */
.input-field {
  width: 100%;
  padding: 10px 12px;
  margin-top: 5px;
  border-radius: 10px;
  border: 1px solid #ddd;
  background: #fafafa;
  font-size: 15px;
  transition: 0.2s;
}

.input-field:focus {
  border-color: #4b8cff;
  box-shadow: 0 0 0 3px rgba(75,140,255,0.25);
  background: white;
}

/* Textarea */
.textarea {
  height: 80px;
  resize: none;
}

/* Tombol */
.modal-actions {
  display: flex;
  justify-content: flex-end;
  margin-top: 18px;
  gap: 10px;
}

.btn {
  padding: 10px 18px;
  border-radius: 12px;
  font-size: 15px;
  font-weight: 600;
  border: none;
  cursor: pointer;
  transition: 0.2s ease;
}

.btn.cancel {
  background: #eee;
  color: #444;
}

.btn.cancel:hover {
  background: #ddd;
}

.btn.save {
  background: #4b8cff;
  color: white;
}

.btn.save:hover {
  background: #3576e6;
}
</style>
<link href="https://fonts.googleapis.com/css2?family=Scheherazade+New:wght@400;700&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
</head>

<body>
<div id="toast"></div>

<!-- RESET CONFIRM -->
<div id="confirmOverlay">
    <div id="confirmBox">
        <h3>Reset Semua Soal?</h3>
        <button class="red" onclick="doReset()">Ya, Reset</button>
        <button style="background:#4c82ff;color:white" onclick="hideConfirm()">Batal</button>
    </div>
</div>

<!-- DELETE CONFIRM -->
<div id="deleteOverlay">
    <div id="deleteBox">
        <h3>Hapus Soal Ini?</h3>
        <button class="red" onclick="doDelete()">Ya, Hapus</button>
        <button style="background:#4c82ff;color:white" onclick="hideDeleteConfirm()">Batal</button>
    </div>
</div>

<div class="wrap">

    <!-- INPUT -->
    <div class="card">
        <h2 style="margin-top:0;text-align:center">Generator Soal Pesantren</h2>

        <label>Semester</label>
        <select id="semester">
            <option value="I">Semester I</option>
            <option value="II">Semester II</option>
        </select>

        <label>Tahun Pelajaran</label>
        <input id="tahun" placeholder="2025/2026">

        <label>Fan / Mapel (Arab)</label>
        <input id="fan" placeholder="مثال : التوحيد" style="direction:rtl;text-align:right">

        <label>Kelas</label>
        <select id="kelas">
            <option>SP (Sekolah Persiapan)</option><option>I (Satu)</option><option>II (Dua)</option>
            <option>III (Tiga)</option><option>IV (Empat)</option><option>I (Satu Putri)</option><option>II (Dua Putri)</option>
            <option>III (Tiga Putri)</option><option>IV (Empat Putri)</option>
        </select>
		<label>Judul PDF (opsional):</label>
		<input id="judulPdf" type="text" placeholder="Kosongkan untuk default">

        <!-- toggle -->
        <div class="toggleBox">
            <span id="modeLabel">Arab (RTL)</span>
            <div class="toggleBtn" onclick="toggleMode()">
                <div class="toggleKnob rtl" id="knob"></div>
            </div>
        </div>

        <label>Tulis Soal</label>
        <textarea id="soalInput" dir="rtl" style="text-align:right" placeholder="Tulis soal disini....."></textarea>

        <button onclick="addSoal()">Tambah Soal</button>
    </div>

    <!-- LIST -->
    <div class="card">
        <h3 style="margin-top:0">Daftar Soal (<span id="totalCount">0</span>)</h3>
        <table>
            <tbody id="tbodySoal"></tbody>
        </table>

        <button onclick="openPreview()">Lihat & Print Browser</button>
		<button style="margin-top:10px;background:#28a745" onclick="downloadPDF()">Download PDF</button>
        <button class="red" onclick="showConfirm()">Reset</button>
    </div>

</div>


<iframe id="printFrame" style="display:none;"></iframe>
<script>
/* --------------------------------------------------------------
   DATA
-------------------------------------------------------------- */
let daftar = JSON.parse(localStorage.getItem("soal_asli") || "[]");
let modeArab = true;

const arabDigits = ["٠","١","٢","٣","٤","٥","٦","٧","٨","٩"];

/* convert angka */
function toArabicNumber(n){
    return String(n).split("").map(c => /\d/.test(c) ? arabDigits[+c] : c).join("");
}

/* toast */
function toast(msg){
    const t=document.getElementById("toast");
    t.innerText=msg;
    t.classList.add("show");
    setTimeout(()=>{ t.classList.remove("show"); },2200);
}

/* --------------------------------------------------------------
   RENDER LIST
-------------------------------------------------------------- */
function renderList(){
    const tbody=document.getElementById("tbodySoal");
    tbody.innerHTML="";

    daftar.forEach((it,i)=>{
        let tr=document.createElement("tr");

        let tdNo=document.createElement("td");
        tdNo.style.fontWeight="700";
        tdNo.textContent = it.mode==="arab" ? toArabicNumber(i+1) : (i+1);

        let tdText=document.createElement("td");
        tdText.textContent=it.text;
        tdText.style.textAlign = it.mode==="arab" ? "right" : "left";

        let tdAct=document.createElement("td");
        let b1=document.createElement("button");
        b1.className="iconBtn";
        b1.textContent="Edit";
        b1.onclick=()=>editItem(i);

        let b2=document.createElement("button");
b2.className="iconBtn del";
b2.textContent="Hapus";
b2.onclick=()=>showDeleteConfirm(i);

        tdAct.append(b1," ",b2);

        tr.append(tdNo,tdText,tdAct);
        tbody.appendChild(tr);
    });

    document.getElementById("totalCount").innerText=daftar.length;
}

function save(){
    localStorage.setItem("soal_asli", JSON.stringify(daftar));
    renderList();
}

/* --------------------------------------------------------------
   INPUT FUNCTIONS
-------------------------------------------------------------- */
function isRTL(txt){
    return /[\u0600-\u06FF]/.test(txt); // huruf Arab
}
function addSoal(){
    let t=document.getElementById("soalInput").value.trim();
    if(!t){ toast("Tulis soal dulu"); return; }

    daftar.push({
        text: t,
        mode: modeArab ? "arab" : "latin",
        direction: modeArab ? "rtl" : "ltr"
    });

    document.getElementById("soalInput").value="";
    save();
    toast("Soal ditambahkan!");
}
let editingIndex = null;

function editItem(i){
    let s = daftar[i];

    // isi teks ke textarea edit
    document.getElementById("editQuestion").value = s.text;

    // atur arah teks
    document.getElementById("editQuestion").style.direction = s.direction;
    document.getElementById("editQuestion").style.textAlign = 
        s.direction === "rtl" ? "right" : "left";

    editingIndex = i;

    // buka modal
    document.getElementById("editModal").style.display = "flex";
}

/* RESET */
function hideConfirm(){
    document.getElementById("confirmOverlay").style.display="none";
}
function doReset(){
    daftar=[];
    save();
    hideConfirm();
    toast("Semua soal direset");
}
let deleteIndex = null;

/* SHOW modal delete */
function showDeleteConfirm(i){
    deleteIndex = i;
    document.getElementById("deleteOverlay").style.display = "flex";
}

/* HIDE modal delete */
function hideDeleteConfirm(){
    document.getElementById("deleteOverlay").style.display = "none";
}

/* PROSES HAPUS */
function doDelete(){
    if(deleteIndex !== null){
        daftar.splice(deleteIndex, 1);
        save();
        toast("Soal dihapus");
    }
    hideDeleteConfirm();
}
function showConfirm(){
    document.getElementById("confirmOverlay").style.display="flex";
}

function hideConfirm(){
    document.getElementById("confirmOverlay").style.display="none";
}

function doReset(){
    daftar = [];
    save();
    hideConfirm();
    toast("Semua soal direset");
}
/* --------------------------------------------------------------
   TOGGLE MODE
-------------------------------------------------------------- */
function toggleMode(){
    modeArab=!modeArab;
    const knob=document.getElementById("knob");
    const inp=document.getElementById("soalInput");
    const label=document.getElementById("modeLabel");

    if(modeArab){
        knob.classList.add("rtl");
        label.textContent="Arab (RTL)";
        inp.dir="rtl"; inp.style.textAlign="right";
    } else {
        knob.classList.remove("rtl");
        label.textContent="Latin (LTR)";
        inp.dir="ltr"; inp.style.textAlign="left";
    }
}

/* --------------------------------------------------------------
   PREVIEW
-------------------------------------------------------------- */
function openPreview(){
    if(!daftar.length){
        toast("Belum ada soal");
        return;
    }

    let sem = document.getElementById("semester").value;
    let th = document.getElementById("tahun").value;
    let fan = document.getElementById("fan").value;
    let kelas = document.getElementById("kelas").value;

	let html = `
		<div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">

		<!-- Logo kiri PPDA -->
		<img src="https://i.imgur.com/ophjlHz.jpg" style="width:115px; height:auto;">

		<!-- KOP -->
		<div style="text-align:center; flex:1; font-size:13pt; font-weight:700; line-height:1.6;">
			UJIAN AKHIR SEMESTER ${sem} <br>
			MUHADHOROH “MANBAUS SHOLAH” <br>
			PONDOK PESANTREN DARUTTAUHID AL ALAWI <br>
			TAHUN PELAJARAN ${th}
		</div>

		<!-- Logo kanan MADIN -->
		<img src="https://i.imgur.com/krmDDLO.jpg" style="width:115px; height:auto;">

		</div>

		<div style="border-bottom: 2px solid black; margin: 10px 0 15px 0;"></div>


		<!-- IDENTITAS -->
		<div style="display:flex; gap:10px; margin:18px 0; align-items:flex-start;">

			<!-- Fan & Kelas -->
			<table style="width:6.2cm; font-size:12pt; line-height:1.1;">
				<tr>
					<td style="padding:10px 0; width:auto;">Fan</td>
					<td style="padding:10px 0; width:auto;">:</td>
					<td style="padding:10px 0;">${fan}</td>
				</tr>
				<tr>
					<td style="padding:10px 0;">Kelas</td>
					<td style="padding:10px 0;">:</td>
					<td style="padding:10px 0;">${kelas}</td>
				</tr>
			</table>

			<!-- Nama & No Ujian -->
			<table style="width:8.3cm; font-size:12pt; line-height:1.1;">
				<tr>
					<td style="padding:10px 0; width:2.6cm;">Nama</td>
					<td style="padding:10px 0; width:0.4cm;">:</td>
					<td style="padding:10px 0;">..................................................</td>
				</tr>
				<tr>
					<td style="padding:10px 0;">No. Ujian</td>
					<td style="padding:10px 0;">:</td>
					<td style="padding:10px 0;">..................................................</td>
				</tr>
			</table>

			<!-- Kotak Nilai -->
			<table style="width:4cm; font-size:12pt; border:1px solid black; text-align:center;">
				<tr>
					<td style="padding:5px; border-bottom:1px solid black; font-weight:bold;">NILAI</td>
				</tr>
				<tr>
					<td style="padding:10px 0;">&nbsp;</td>
				</tr>
			</table>

		</div>
		<div style="border-bottom: 1px solid black; margin: 10px 0 20px 0;"></div>
		
		<!-- TEKS ARAB -->
		<p style="font-size:20pt; font-weight:bold; text-decoration:underline; text-align:center;">
		  <span dir="rtl">أجب هذه الأسئلة بأجوبة موافقة !</span>
		</p>

	`;


	daftar.forEach((it, i) => {
		if (it.mode === "arab") {
			html += `
			<div style="margin-bottom:12px; direction:rtl;">
				<table style="width:100%; border-collapse:collapse; font-family:'Scheherazade New', serif; font-size:16pt;">
					<tr>
						<td style="width:28px; white-space:nowrap; vertical-align:top; padding-left:5px;">
							${toArabicNumber(i+1)}.
						</td>
						<td style="text-align:right; vertical-align:top;">
							${it.text}
						</td>
					</tr>
				</table>
			</div>

			`;
		} else {
			html += `
			<div style="margin-bottom:12px; direction:ltr;">
				<table style="width:100%; border-collapse:collapse; font-size:14pt;">
					<tr>
						<td style="width:28px; white-space:nowrap; vertical-align:top; padding-right:4px;">
							${i+1}.
						</td>
						<td style="vertical-align:top;">
							${it.text}
						</td>
					</tr>
				</table>
			</div>

			`;
		}
	});

    // === CETAK PAKAI IFRAME (PALING AMAN) ===
    const frame = document.getElementById("printFrame");
    const doc = frame.contentWindow.document;

    doc.open();
    doc.write(`
        <html>
        <head>
		<title>SOAL - ${fan} - Kelas ${kelas}</title>
            <style>
			    @page { 
						size: 210mm 330mm; 
						margin: 10mm 5mm 5mm 5mm; /* atas | kanan | bawah | kiri */
					  }

                body { font-family: Arial, sans-serif; }
                .paper {
                    width:210mm;
                    min-height:330mm;
                    padding:10mm;
                    box-sizing:border-box;
                }
            </style>
        </head>
        <body>
            <div class="paper">${html}</div>
        </body>
        </html>
    `);
    doc.close();

    setTimeout(() => {
        frame.contentWindow.focus();
        frame.contentWindow.print();
    }, 150);
}

function printPDF(){
    const iframe = document.getElementById("printFrame");
    const doc = iframe.contentWindow.document;

    // Ambil HTML yang mau dicetak
    const content = document.getElementById("printArea").innerHTML;

    doc.open();
    doc.write(`
        <html>
        <head>
            <title>Cetak Soal</title>
            <style>
                @page {
                    size: 210mm 330mm; /* F4 */
                    margin: 15mm;
                }
                body {
                    margin:0;
                    font-family: Arial, Helvetica, sans-serif;
                }
                .paper {
                    width:210mm;
                    min-height:330mm;
                    padding:15mm;
                    box-sizing:border-box;
                }
            </style>
        </head>
        <body>
            <div class="paper">
                ${content}
            </div>
        </body>
        </html>
    `);
    doc.close();

    // Tunggu sebentar lalu print
    setTimeout(() => {
        iframe.contentWindow.focus();
        iframe.contentWindow.print();
    }, 150);
}
function closeEdit() {
  document.getElementById("editModal").style.display = "none";
}
function saveEdit(){
    let newText = document.getElementById("editQuestion").value.trim();

    let dir = isRTL(newText) ? "rtl" : "ltr";

    daftar[editingIndex].text = newText;
    daftar[editingIndex].direction = dir;
    daftar[editingIndex].mode = dir === "rtl" ? "arab" : "latin";

    save();
    closeEdit();

    toast("Soal diperbarui!");
}
function downloadPDF(){
    if(!daftar.length){
        toast("Belum ada soal");
        return;
    }

    let sem = document.getElementById("semester").value;
    let th = document.getElementById("tahun").value;
    let fan = document.getElementById("fan").value;
    let kelas = document.getElementById("kelas").value;

    // Generate ulang HTML seperti openPreview()
    let frame = document.getElementById("printFrame");
    let doc = frame.contentWindow.document;

    // Buat isi PDF
    let pageHTML = `
    <div id='paperPDF' style='width:210mm; min-height:330mm; padding:15mm; box-sizing:border-box;'>
        ${document.querySelector(".paper") ? document.querySelector(".paper").innerHTML : "" }
    </div>
    `;

    // Buat node untuk PDF
    let temp = document.createElement("div");
    temp.innerHTML = pageHTML;
    document.body.appendChild(temp);

    let opt = {
        margin: 10,
        filename: `${fan}-${kelas}.pdf`,
        image: { type: 'jpeg', quality: 1 },
        html2canvas: { scale: 3 },
        jsPDF: { unit: 'mm', format: [210,330], orientation: 'portrait' }
    };

    html2pdf().set(opt).from(temp).save().then(()=>{
        temp.remove();
    });
}
function downloadPDF() {
    if (!daftar.length) {
        toast("Belum ada soal");
        return;
    }

    let sem = document.getElementById("semester").value;
    let th = document.getElementById("tahun").value;
    let fan = document.getElementById("fan").value;
    let kelas = document.getElementById("kelas").value;

    // Input judul dari user
    let customTitle = document.getElementById("judulPdf")?.value.trim();

    // Jika kosong → pakai default "Kelas - Fan"
    let filename = customTitle !== "" ? customTitle : `${kelas} - ${fan}`;

    // === BANGUN ULANG HTML (copy dari openPreview) ===
    let html = document.getElementById("printArea")
        ? document.getElementById("printArea").innerHTML
        : "";

    // Buat container untuk html2pdf
    let wrapper = document.createElement("div");
    wrapper.innerHTML = `
        <div style="width:210mm; min-height:330mm; padding:15mm; box-sizing:border-box;">
            ${html}
        </div>
    `;

    document.body.appendChild(wrapper);

    let opt = {
        margin: 10,
        filename: filename + ".pdf",
        image: { type: "jpeg", quality: 1 },
        html2canvas: { scale: 3 },
        jsPDF: { unit: "mm", format: [210, 330], orientation: "portrait" }
    };

    html2pdf().set(opt).from(wrapper).save().then(() => {
        wrapper.remove();
    });
}

/* INIT */
renderList();
</script>
<div id="editModal" class="modal">
  <div class="edit-box">
    <h2 class="modal-title">Edit Soal</h2>

    <label class="input-label">Teks Soal</label>
    <textarea id="editQuestion" class="input-field textarea"></textarea>

    <div class="modal-actions">
      <button class="btn cancel" onclick="closeEdit()">Batal</button>
      <button class="btn save" onclick="saveEdit()">Simpan</button>
    </div>
  </div>
</div>
</body>
</html>
